<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel de Expedi√ß√£o</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body { background-color: black; color: white; font-family: Arial; margin: 0; padding: 0; }
    .header { background-color: #111; padding: 2vh; text-align: center; font-size: clamp(30px, 5vw, 60px); font-weight: bold; border-bottom: 4px solid #333; }
    .clock { font-size: clamp(20px, 3vw, 30px); color: #ccc; }
    .container { padding: 2vh 2vw; }
    .line-title { text-align: center; font-size: clamp(24px, 4vw, 50px); margin-bottom: 2vh; }
    .request { background-color: #28a745; padding: 3vh 2vw; margin-bottom: 2vh; border-radius: 20px; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; font-size: clamp(24px, 4vw, 48px); font-weight: bold; }
    .request div { flex: 1 1 40%; }
    .yellow { background-color: #ffc107; animation: blinkYellow 1s infinite; }
    .red { background-color: #dc3545; animation: blinkRed 1s infinite; }
    @keyframes blinkYellow { 0%, 100% { background-color: #ffc107; } 50% { background-color: white; color: black; } }
    @keyframes blinkRed { 0%, 100% { background-color: #dc3545; } 50% { background-color: white; color: black; } }
    button.atender-btn { background-color: #007bff; border: none; color: white; font-size: clamp(20px, 3vw, 36px); padding: 1vh 2vw; border-radius: 15px; cursor: pointer; margin-left: 2vw; font-weight: bold; }
    .footer { position: fixed; bottom: 10px; right: 20px; font-size: clamp(14px, 2vw, 20px); color: #888; }
    .btn-clear { background-color: #dc3545; color: white; }
    .btn-audio { background-color: #198754; color: white; }
    table { width: 100%; font-size: clamp(16px, 2.5vw, 24px); }
    th, td { padding: 1vh; text-align: center; }
  </style>
</head>
<body>
  <div class="header">Painel de Expedi√ß√£o <div class="clock" id="clock"></div></div>
  <div class="container">
    <div class="line-title">Requisi√ß√µes Pendentes</div>
    <div id="pendingArea"></div>
    <hr style="margin: 40px 0;">
    <div class="line-title">Hist√≥rico de Requisi√ß√µes</div>
    <div>
      <select id="lineSelect"><option value="">Selecione uma linha</option></select>
      <button class="btn-clear" onclick="clearHistory()">Limpar Hist√≥rico</button>
      <button class="btn-audio" onclick="toggleAudio()" id="audioButton">Ativar √Åudio üîä</button>
    </div>
    <div id="historyArea">
      <table border="1">
        <thead><tr><th>Data e Hora</th><th>Tempo de Atendimento</th></tr></thead>
        <tbody id="historyTable"></tbody>
      </table>
    </div>
  </div>
  <div class="footer">By Ricardo Moura</div>

  <audio id="alertNew" src="audio/alert-new.mp3"></audio>
  <audio id="alertWarning" src="audio/alert-warning.mp3"></audio>
  <audio id="alertTimeout" src="audio/alert-timeout.mp3"></audio>

<script>
const socket = io({ transports: ['websocket'] });
let productionLines = [];
let pendingRequests = [];
let isAudioPlaying = false;
const requestTimers = {};

document.addEventListener('click', () => {
  const audios = ['alertNew', 'alertWarning', 'alertTimeout'].map(id => document.getElementById(id));
  audios.forEach(audio => {
    if (audio) {
      audio.play().then(() => {
        audio.pause();
        audio.currentTime = 0;
      }).catch(() => {});
    }
  });
}, { once: true });

window.onload = () => {
  const audioStatus = localStorage.getItem('audioEnabled');
  setAudioEnabled(audioStatus === 'true');
  updateClock();
};

function setAudioEnabled(value) {
  localStorage.setItem('audioEnabled', value);
  updateAudioButton();
}

function isAudioEnabled() {
  return localStorage.getItem('audioEnabled') === 'true';
}

function toggleAudio() {
  const current = isAudioEnabled();
  setAudioEnabled(!current);
}

function updateAudioButton() {
  const state = isAudioEnabled();
  const btn = document.getElementById('audioButton');
  btn.innerText = state ? 'Desativar √Åudio üîá' : 'Ativar √Åudio üîä';
  btn.style.backgroundColor = state ? '#ffc107' : '#198754';
}

function updateClock() {
  const now = new Date();
  document.getElementById('clock').textContent = now.toLocaleTimeString('pt-BR');
}
setInterval(updateClock, 1000);

socket.on('initialData', ({ productionLines: lines, pendingRequests: pending }) => {
  productionLines = lines;
  pendingRequests = pending;
  const lineSelect = document.getElementById('lineSelect');
  lineSelect.innerHTML = '<option value="">Selecione uma linha</option>' +
    lines.map((l) => `<option value="${l.name}">${l.name}</option>`).join('');
  renderPendingRequests();
});

socket.on('componentRequested', (request) => {
  pendingRequests.push(request);
  renderPendingRequests();
  if (isAudioEnabled()) playAudio('alertNew');
});

socket.on('requestAttended', ({ timestamp }) => {
  stopTimer(timestamp);
  pendingRequests = pendingRequests.filter((r) => r.timestamp !== timestamp);
  renderPendingRequests();
  updateHistory();
});

document.getElementById('lineSelect').addEventListener('change', () => {
  const selectedLine = document.getElementById('lineSelect').value;
  if (selectedLine) updateHistory();
  else document.getElementById('historyTable').innerHTML = '';
});

function renderPendingRequests() {
  const area = document.getElementById('pendingArea');
  area.innerHTML = '';
  if (pendingRequests.length === 0) {
    area.innerHTML = `<div style="font-size:clamp(24px,4vw,40px);text-align:center;">Sem requisi√ß√µes pendentes</div>`;
    return;
  }
  pendingRequests.forEach((r) => {
    const div = document.createElement('div');
    div.className = 'request green';
    div.dataset.timestamp = r.timestamp;
    div.dataset.alertedWarning = 'false';
    div.dataset.lastTimeoutAlert = '0';
    div.innerHTML = `
      <div>
  <strong>Linha:</strong> ${r.name}<br />
  <strong>Embalagem:</strong> <span style="color: yellow;">${r.embalagem || 'N/A'}</span><br />
  <strong>Solicitado em:</strong> ${r.date}
</div>
      <div id="timer-${r.timestamp}">00:00:00</div>
      <button class="atender-btn" onclick="attendRequest('${r.name}', ${r.timestamp})">Atender</button>
    `;
    area.appendChild(div);
    startTimer(r);
  });
}

function startTimer(request) {
  const timestamp = request.timestamp;
  if (requestTimers[timestamp]) return;

  requestTimers[timestamp] = setInterval(() => {
    if (!pendingRequests.find(r => r.timestamp === timestamp)) {
      stopTimer(timestamp);
      return;
    }

    const now = Date.now();
    const diff = now - timestamp;
    const totalMinutes = Math.floor(diff / 60000);

    const div = document.querySelector(`.request[data-timestamp="${timestamp}"]`);
    if (!div) {
      stopTimer(timestamp);
      return;
    }

    const hours = String(Math.floor(diff / 3600000)).padStart(2, '0');
    const minutes = String(Math.floor((diff % 3600000) / 60000)).padStart(2, '0');
    const seconds = String(Math.floor((diff % 60000) / 1000)).padStart(2, '0');
    div.querySelector(`#timer-${timestamp}`).textContent = `${hours}:${minutes}:${seconds}`;

    div.classList.remove('green', 'yellow', 'red');

    if (totalMinutes < 10) {
      div.classList.add('green');
      div.dataset.alertedWarning = 'false';
      div.dataset.lastTimeoutAlert = '0';
      return;
    }

    if (totalMinutes >= 10 && totalMinutes <= 20) {
      div.classList.add('yellow');
      if (div.dataset.alertedWarning !== 'true') {
        if (isAudioEnabled()) playAudio('alertWarning');
        div.dataset.alertedWarning = 'true';
      }
      return;
    }

    if (totalMinutes > 20) {
      div.classList.add('red');
      const lastAlert = parseInt(div.dataset.lastTimeoutAlert || '0');
      if (Date.now() - lastAlert >= 5 * 60 * 1000) {
        if (isAudioEnabled()) playAudio('alertTimeout');
        div.dataset.lastTimeoutAlert = Date.now().toString();
      }
    }
  }, 1000);
}

function stopTimer(timestamp) {
  if (requestTimers[timestamp]) {
    clearInterval(requestTimers[timestamp]);
    delete requestTimers[timestamp];
  }
}

function updateHistory() {
  const selectedLine = document.getElementById('lineSelect').value;
  if (!selectedLine) return;
  fetch('/get-history?lineName=' + encodeURIComponent(selectedLine))
    .then((res) => res.json())
    .then((history) => {
      const historyTable = document.getElementById('historyTable');
      if (history.length === 0) {
        historyTable.innerHTML = '<tr><td colspan="2">Sem hist√É¬≥rico</td></tr>';
        return;
      }
      historyTable.innerHTML = history.map((h) => `<tr><td>${h.requestDate}</td><td>${h.timeTaken}</td></tr>`).join('');
    });
}

function clearHistory() {
  const lineName = document.getElementById('lineSelect').value;
  if (!lineName) { alert('Selecione uma linha para limpar o hist√É¬≥rico.'); return; }
  if (!confirm(`Deseja realmente limpar o hist√É¬≥rico da linha ${lineName}?`)) return;
  fetch('/clear-history', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ lineName }),
  }).then((res) => {
    if (res.ok) { alert('Hist√É¬≥rico limpo com sucesso!'); updateHistory(); }
    else { alert('Erro ao limpar hist√É¬≥rico.'); }
  });
}

function attendRequest(lineName, timestamp) {
  stopTimer(timestamp);
  pendingRequests = pendingRequests.filter((r) => r.timestamp !== timestamp);
  renderPendingRequests();
  socket.emit('attendRequest', { lineName, timestamp });
}

function playAudio(id) {
  if (!isAudioEnabled()) return;
  if (isAudioPlaying) return;

  const audio = document.getElementById(id);
  if (audio) {
    isAudioPlaying = true;
    audio.pause();
    audio.currentTime = 0;
    audio.play().catch(() => {}).finally(() => {
      audio.onended = () => { isAudioPlaying = false; };
    });
  }
}
</script>
</body>
</html>
